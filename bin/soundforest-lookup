#!/usr/bin/env python
"""
Script to lookup files by name from a tree 
"""

import re,os

from systematic.shell import Script,ScriptError
from soundforest.database.models import SoundForestDB

RE_TRACKNUMBER = re.compile('^(?P<tracknumber>[0-9]+) (?P<filename>(.*))$')

DEFAULT_TREE = '/music/m4a'
DEFAULT_TREE_TYPE = 'Songs'

USAGE = """Lookup files by name from library database."""
script = Script(description=USAGE)
script.add_argument('-T','--tree',default=DEFAULT_TREE,help='Search files from this tree')
script.add_argument('paths',nargs='*',help='Paths to process')
args = script.parse_args()
if not args or not args.tree:
    script.exit(1,script.get_usage())

adb = SoundForestDB()
tree = adb.match_tree(args.tree)

names = []
for arg in args.paths:
    arg = unicode(arg,'utf-8')
    if os.path.isfile(arg):
        names.append(arg)
    if os.path.isdir(arg):
        names.extend([os.path.join(arg,x) for x in os.listdir(arg)])

for name in names:
    m = RE_TRACKNUMBER.match(os.path.basename(name))
    if m:
        name = m.groupdict()['filename']
    matches = tree.match(name)
    for p in tree.match(name):
        print p.realpath

